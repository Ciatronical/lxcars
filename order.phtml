<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>

    <?php
        require_once( __DIR__."/../inc/stdLib.php" );
        echo $menu['stylesheets'];
        echo $menu['javascripts'];
        echo $head['THEME'];
    ?>

    <script type="text/javascript" src="jQueryAddOns/date-time-picker.js"></script>
    <script type="text/javascript" src="jQueryAddOns/german-date-time-picker.js"></script>
    <link rel="stylesheet" href="css/lxc.Order.css" type="text/css" title="Stylesheet">
    <script type="text/javascript" src="js/lxc.Part.js"></script>
    <script type="text/javascript" src="kivi.Order.js"></script>

  </head>
  <body>

    <?php
        echo $menu['pre_content'];
        echo $menu['start_content'];
    ?>

    <p class="ui-state-highlight ui-corner-all tools" style="margin-top: 20px; padding: 0.6em;">Order</p>

    <div class="ui-widget-content">
      <div>
        <p class="tools ui-state-highlight ui-corner-all lang " style="margin-top: 20px; padding: 0.6em;" data-lang="HEADLINE">
          <label id="head01">Auftragsnummer:</label>
          <label id="head02">0000</label>
          <label id="head03">Auftraggeber:</label>
          <label id="head04"></label></br>
          <label id="head05">Fertigstellung:</label>
          <input id="head06" type="text">
          <label id="head07">KM-Stand:</label>
          <input id="head08" type="text"></br>
          <label id="head09">bearbeitet von:</label>
          <label id="head19">Amtl.-Kennz.:</label>
          <input id="head20" type="text"></br>
          <label id="head10"></label>
          <label id="head11">bearbeitet am:</label>
          <label id="head12"></label></br>
          <label id="head13">KfZ:</label>
          <select id="head14" type="text">
            <option>Auto nicht hier</option>
            <option selected="selected">Auto hier</option>
            <option>Sonstiges zur Reparatur gebracht</option>
            <option>Bestellung</option>
          </select></br>
          <label id="head15">erstellt am:</label>
          <label id="head16"></label>
          <label id="head17">Status:</label>
          <select id="head18" type="text">
            <option></option>
            <option>angenommen</option>
            <option>bearbeitet</option>
            <option selected="selected">abgerechnet</option>
          </select>
        </p>

      </div>

      <table width="100%">
        <tr>
          <td>
            <div id="row_table_scroll_id" style="overflow-y: auto; height: 25vh">
              <table id="row_table_id"  class='ui-sortable' width="100%">
                <thead>
                  <tr class="listheading pin">
                    <th class="listheading" nowrap width="25px" >Position </th>
                    <th class="listheading" style='text-align:center' nowrap width="1"><img src="image/updown.png" alt="umsortieren"></th>
                    <th class="listheading" style='text-align:center' nowrap width="1"><img src="image/close.png" alt="löschen"></th>
                    <th id="partnumber_header_id"  class="listheading" nowrap width="15"><a href='#' onClick='javascript:kivi.Order.reorder_items("partnumber")'> Artikelnummer</a></th>
                    <th id="partclass_header_id"   class="listheading" nowrap width="2">Typ</th>
                    <th id="description_header_id" class="listheading" nowrap           ><a href='#' onClick='javascript:kivi.Order.reorder_items("description")'>Beschreibung</a></th>
                    <th id="qty_header_id"         class="listheading" nowrap width="5" ><a href='#' onClick='javascript:kivi.Order.reorder_items("qty")'>        Menge</a></th>
                    <th class="listheading" nowrap width="5" >Einheit </th>
                    <th id="sellprice_header_id"   class="listheading" nowrap width="15" ><a href='#' onClick='javascript:kivi.Order.reorder_items("sellprice")'> Preis</a></th>
                    <th id="discount_header_id"    class="listheading" nowrap width="15" ><a href='#' onClick='javascript:kivi.Order.reorder_items("discount")'>  Rabatt in %</a></th>
                    <th class="listheading" nowrap width="10">Gesamt </th>
                    <th class="listheading" nowrap width="5" >Mechaniker </th>
                    <th class="listheading" nowrap width="5" >Status </th>
                  </tr>
                </thead>

                <tbody class="row_entry listrow listrow ">
                  <tr style="width: 1533px;">
                    <td>
                      <div class="numeric" name="position">1</div>
                    </td>
                    <td align="center">
                      <img src="../../image/updown.png" alt="Eintrag umsortieren" class="dragdrop">
                    </td>
                    <td align="center"> <!--onclick entfernt die selektierte Position außer Position 1-->
                      <input value="X" onclick="if($(this).parent().parent().children().children('[name=position]').text()=='1')return false; if (!confirm(&quot;Sind Sie sicher?&quot;)) return false;  kivi.Order.delete_order_item_row(this)" type="button">
                    </td>
                    <td>
                      <div name="partnumber"></div>
                    </td>
                    <td>
                      <div name="partclassification"></div>
                    </td>
                    <td>
                      <span class="part_picker"><input type="hidden" class="add_item_input part_autocomplete" name="add_item.parts_id" value="" data-part-picker-data="{&quot;fat_set_item&quot;:1,&quot;class&quot;:&quot;add_item_input&quot;,&quot;style&quot;:&quot;width: 300px&quot;}"><input type="text" fat_set_item="1" style="width: 300px" class="add_item_input" name="item_partpicker_name" value=""></span>
                      <img src="../../image/edit-entry.png" onclick="kivi.switch_areainput_to_textarea('add_item_parts_id_name')" style="margin-left: 2px;">
                    </td>
                    <td>
                      <span>
                        <input size="5" name="qty_as_number" class="recalc reformat_number numeric" value="1.00" type="text">
                      </span>
                    </td>
                    <td nowrap="">
                      <select class="unitselect" name="unit" ></select>
                    </td>
                    <td>
                      <span>
                        <input class="recalc reformat_number numeric pos1" value=""  size="10" name="sellprice_as_number" type="text">
                      </span>
                    </td>
                    <td>
                      <span>
                        <input value="0.00" class="recalc reformat_number numeric pos1" name="discount_as_percent" size="5" type="text">
                      </span>
                    </td>
                    <td align="center">
                      <span>
                        <div name="linetotal">0.00</div>
                      </span>
                    </td>
                    <td nowrap="">
                      <select class="unitselect" name="mechanics" ></select>
                    </td>
                    <td nowrap="">
                      <select name="pos_status" class="unitselect">
                        <option value="0" selected="true"></option>
                        <option value="gelesen">gelesen</option>
                        <option value="Bearbeitung">Bearbeitung</option>
                        <option value="erledigt">erledigt</option>
                      </select>
                    </td>
                  </tr>
                </tbody>
              </table>
              <br>
                <li>
                  <label id="netto">Netto:</label>
                  <input name="pos_orderTotalNetto" value="0" type="text" id="orderTotalNetto" class="recalc reformat_number numeric">
                </li><br>
                <li>
                  <label id="brutto">Brutto:</label>
                  <input name="pos_orderTotalBrutto" value="0" type="text" id="orderTotalBrutto" class="recalc reformat_number numeric">
                </li>
            </div>
          </td>
        </tr>
      </table>
      <div>
        <button id="backToCRM" class="ui-button ui-corner-all ui-widget" style="margin: 5px;">CRM</button><button id="backToOrderList" class="ui-button ui-corner-all ui-widget" style="margin: 5px;">Back to Orderlist</button><button id="backToCar" class="ui-button ui-corner-all ui-widget" style="margin: 5px;">Back to Car</button><button id="printOrder" class="ui-button ui-corner-all ui-widget" style="margin: 5px;">Print</button><button id="pdfOrder" class="ui-button ui-corner-all ui-widget" style="margin: 5px;">PDF</button>
      </div>
    </div>

    <script type="text/javascript">

      $( document ).ready( function(){

        $.urlParam = function( name ){
          var results = new RegExp( '[\?&]' + name + '=([^&#]*)' ).exec( window.location.href );
          if( results == null );// alert( 'Parameter: "' + name + '" does not exist in "' + window.location.href + '"!' );
          else return decodeURIComponent( results[1] || 0 );
        }



        var kivi_global = jQuery.parseJSON( kivi.myconfig.global_conf );
        var baseUrl = kivi_global.baseurl;
        $('[name=item_partpicker_name]').focus();
        //kivi.Part.newPositionRow(); //Warum?? Die erste Position ist doch schon da!!
        //Achtung die ID "add_item_parts_id_name* darf nicht mehrfach im DOM vorhanden sein!!!

        $.ajax({
          url: 'ajax/order.php?action=getMechanics',
          type: 'GET',
          success: function( data ){
            $.each( data, function( index, item ){
            //console.log(item);
              $( '[name = mechanics]' ).append( $( '<option class="opt mech__' + item.name + '" value="'+item.name + '">' + item.name + '</option>' ) );
            })
          },
          error:  function(){
            alert( "Ajaxerror getMechnics()!");
          }
        })

        $.ajax({
          url: 'ajax/order.php?action=getUnits',
          type: 'GET',
          success: function( data ){
            $.each( data, function( index, item ){
              $( '[name = unit]' ).append($( '<option class="opt unit__' + item.name + '" value="' + item.name + '">' + item.name + '</option>' ) );
            })
          },
          error:  function(){
            alert( "Error getUnits()!" );
          }
        })

        //Calculate rowprice
        $( document ).on( 'keyup','.recalc', function(){
          var price = parseFloat( $( ':focus' ).parents().eq( 2 ).find( '[name=sellprice_as_number]' ).val() );
          var number = parseFloat( $( ':focus' ).parents().eq( 2 ).find( '[name=qty_as_number]' ).val() );
          var discount = parseFloat( $( ':focus' ).parents().eq( 2 ).find( '[name=discount_as_percent]' ).val() );
          discount = discount / 100;
          $( ':focus' ).parents().eq( 2 ).find( '[name=linetotal]' ).text( parseFloat( price * number - ( price * number * discount ) ).toFixed( 2 ) );//Nachhilfe Mathematik 0175-7880999 (mit Happy End)
          var totalprice=0.00;
          var totalnetto=0.00;
          $('[name=linetotal]').each(function () {

            //console.log(parseFloat(this.textContent).toFixed(2));
            var linetotal=parseFloat(this.textContent);

            console.log(linetotal);
            totalprice = totalprice+linetotal;
            var netto = linetotal-(linetotal*0.19);
            totalnetto=totalnetto+netto;

          });
          console.log(totalprice);
          $('#orderTotalBrutto').val(totalprice.toFixed(2));
          $('#orderTotalNetto').val(totalnetto.toFixed(2));

        });


        //DateTimePicker
        function AddButton( input ){
          setTimeout( function(){
            var buttonPane = $( input ).datepicker( "widget" ).find( ".ui-datepicker-buttonpane" );
            var btn = $('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button"> Wartet</button>');
            btn.appendTo( buttonPane );
            btn.bind( "click", function(){
                $( "#head06" ).val("Kunde wartet! SOFORT anfangen!");
                updateOrderDatabase();
            });
          }, 1 );
        }

        $( "#head06" ).datetimepicker({
          beforeShow: function( input ){
            AddButton(input);
          },
          onChangeMonthYear: function( year, month, inst ){
            AddButton( inst.input );

          },
          stepMinute: 5,
          hour: 1,
          hourMin: 6,
          hourMax: 19,
          timeSuffix: ' Uhr',
          timeText: 'Zeit',
          hourText: 'Stunde',
          closeText: 'Fertig',
          currentText: 'Jetzt'
        });



       $( "#backToCRM" ).button({
            label: "CRM"
        }).css({
            'margin':'5px'
        }).click( function(){
            updateOrderDatabase();
            location.href = baseUrl + '/crm/firma1.php?Q=C&id=' + ow;
            return false;
        });

        $( "#backToOrderList" ).button({
            label: "Back to Orderlist"
        }).css({
            'margin':'5px'
        }).click( function(){
            updateOrderDatabase();
            window.location = baseUrl + '/crm/lxcars/' + previous + '?task=' + task + '&owner=' + ow + '&c_id=' + car;
            return false;
        });

        $( "#backToCar" ).button({
            label: "Back to Car"
        }).css({
            'margin':'5px'
        }).click( function(){
            updateOrderDatabase();
            window.location = baseUrl + '/crm/lxcars/lxcmain.php?owner=' + ow + '&c_id=' + car + '&task=3';
            return false;
        });


        var id = $.urlParam( 'id' );
        $.ajax({
            url: 'ajax/order.php?action=getOrder&data=' + id,
            type: 'GET',
            success: function (data) {

              car = data.c_id;

              if (data.km_stnd == null) {
                  data.km_stnd = '0';
              }
              if (data.car_status == null) {
                  data.car_status = 'Auto hier';
              }

              $('#head02').text(data.ordnumber);
              $('#head04').text(data.customer_name);
              $('#head10').text(kivi.myconfig.name);
              $('#head16').text(data.transdate);
              $('#head06').val(data.finish_time);
              $('#head08').val(data.km_stnd);
              $('#head20').val(data.c_ln);
              $('#head18').val(data.order_status);
              $('#head14').val(data.car_status);
              ow = data.customer_id;
              orderID = data.oe_id;

           }
       });

     });

    </script>

    <?php echo $menu['end_content']; ?>
  </body>
</html>
