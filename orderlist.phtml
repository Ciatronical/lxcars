<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />

<?php
    require_once("../inc/stdLib.php");
    $menu = $_SESSION['menu'];
    echo $menu['stylesheets'];
    echo $menu['javascripts'];
    echo $head['JQUERY'];
    echo $head['JQUERYUI'];
    echo $head['JQTABLE'];
    //echo $head['JQTABLE-PAGER'];
    echo $head['THEME'];
    //echo $head['JUI-DROPDOWN'];
    echo $head['TRANSLATION'];


    include_once( 'inc/lxcLib.php' );
    include_once( '../inc/UserLib.php' );
    include_once ( '../inc/crmLib.php' );

ob_start();

$task = $_GET["task"] ? $_GET["task"] : $_POST["task"];
$c_id = $_GET["c_id"] ? $_GET["c_id"] : $_POST["c_id"];
$owner = $_GET["owner"] ? $_GET["owner"] : $_POST["owner"];
$a_id = $_GET["a_id"] ? $_GET["a_id"] : $_POST["a_id"];
//$b = $_GET["b"] ? $_GET["b"] : $_POST["b"]; if( !$b ) $b = 2 ;//ZurückButton 1==Suche, 2==Fahrzeug
$cd = ShowCar( $c_id );//Fahrzeugdaten holen
?>


<script>


$(document).ready(function() {

    $.urlParam = function( name ){
        var results = new RegExp( '[\?&]' + name + '=([^&#]*)' ).exec( window.location.href );
        if( results == null ) alert( 'Parameter: "' + name + '" does not exist in "' + window.location.href + '"!' );
        else return decodeURIComponent( results[1] || 0 );
    }
    var task  = $.urlParam( 'task'  );
    var owner = $.urlParam( 'owner' );
    var c_id  = $.urlParam( 'c_id'  ); //Car-Id

    var kivi_global = jQuery.parseJSON( kivi.myconfig.global_conf );

    //Filename of this script
    var url = window.location.pathname;
    var filename = url.substring( url.lastIndexOf( '/' ) + 1 );


    var language = kivi.myconfig.countrycode;
    $( ".lang" ).each( function(){
        var key = $( this ).attr( "data-lang" );
        if( $( this ).is( ":input" ) ) $( this ).attr( 'title',  typeof( langData[language][key] ) != 'undefined' ? langData[language][key] : 'LNG ERR'  );
        else $( this ).text( typeof( langData[language][key] ) != 'undefined' ? langData[language][key] : 'LNG ERR'  );
    });

    $("#showtable").tablesorter().tablesorterPager({
        container: $("#pager"),
        size: 9999
    });

    $('.showtableRow').click(function () {
        //console.log($(this).attr('id'));
        window.location = 'order.phtml?task=' + task + '&id='+$(this).attr('id')+'&owner=' + owner + '&c_id=' + c_id + '&previous=' + filename;
    })

    $('#btnNewOrder').button().click(function () {
        $.ajax({
            //hier MUSS ein neuer Auftrag erstellt werden  insert!!!!
            //newOrder() ausführen
            url: 'ajax/order.php?action=getOrderNumber',
            type: 'GET',
            success: function (data) {
                var newOrderNr;
                newOrderNr = parseInt( data[0]['sonumber'] );
                newOrderNr =  newOrderNr + 1;
                window.location = 'order.phtml?task=' + task + '&id=' + newOrderNr + '&owner=' + owner + '&c_id=' + c_id + '&previous=' + filename;//WICHTIG: id hat nichts mit ordnumber zu tun
            },
            error:  function(){ alert("Holen der Auftrags-Nr fehlgeschlagen!"); }
        })
    });

    $('#btnBack').button().click(function () {
        window.location = 'lxcmain.php?task=' + task + '&owner=' + owner + '&c_id=' + c_id;
    });

});

</script>

<style>
 .ui-menu { width: 180px; }
 .tablesorter { width:auto; cursor:pointer; widgets: ['zebra']; sortList: [[0,0]];}

</style>
</head>

<body>
<?php
    echo $menu['pre_content'];
    echo $menu['start_content'];
?>

<?php echo $menu['end_content']; ?>


 <p class="ui-state-highlight ui-corner-all tools lang" style="margin-top: 20px; padding: 0.6em;" data-lang="TESTFILE">Testfile</p>

<?php
//echo $url;
//echo $task;
//echo $c_id;
//echo $owner;
//echo $a_id;
//echo $b;
//printArray($cd);
//+++++++++++++$rs = $GLOBALS['dbh']->getAll('SELECT oe.ordnumber, oe.transdate, oe.amount, oe.status, oe.employee_id, employee.id, employee.name FROM oe, employee WHERE oe.c_id = '.$c_id.' AND employee.id = oe.employee_id ORDER BY ordnumber');
//printArray($rs);
//$rs = $GLOBALS['dbh']->getAll('SELECT oe.ordnumber, oe.transdate, oe.amount, oe.status, oe.employee_id, employee.id, employee.name FROM oe, employee WHERE oe.customer_id = '.$owner.' AND oe.c_id = '.$c_id.' AND employee.id = oe.employee_id ORDER BY ordnumber');
//printArray($rs);

    echo (' <table id="showtable" class="tablesorter">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Auftrags-Nr.</th>
                        <th>Erster Posten</th>
                        <th>Betrag</th>
                    </tr>
                </thead>
                <tbody>');

                $rs = $GLOBALS['dbh']->getAll('
                    SELECT
                        oe.ordnumber,
                        oe.transdate,
                        oe.amount,
                        oe.status,
                        oe.employee_id,
                        orderitems.trans_id,
                        orderitems.description
                    FROM
                        oe,
                        orderitems
                    WHERE
                        oe.customer_id = '.$owner.'
                    AND
                        oe.c_id = '.$c_id.'
                    AND
                        orderitems.trans_id = oe.id
                    AND
                        orderitems.position = 1
                    ORDER BY
                        oe.ordnumber');

                    foreach ($rs as $value){
                        //$var = sprintf(round($value['amount'], 2) == intval($value['amount']) ? "%d" : "%.2f", $value['amount']);
                        //$var = number_format($value['amount'], 2, ',', '.');
                        //echo $var;
                        echo ('
                            <tr id="'.$value['ordnumber'].'" class="showtableRow">
                                <td>'.$value['transdate'].'</td>
                                <td>'.$value['ordnumber'].'</td>
                                <td>'.$value['description'].'</td>
                                <td align="right">'.number_format($value['amount'], 2, ',', '.').'</td>
                            </tr>');
                        //echo ($value['ordnumber'].', '.$value['transdate'].', '.number_format($value['amount'], 2, ',', '.').', '.$value['name'].'<br>');
                    }
                    echo (  '</tbody></table>'
                            .$head["JQTABLE-PAGER"].
                            '<input type="button" id="btnNewOrder" value="Neuer Auftrag">
                             <input type="button" id="btnBack" value="Zur&uuml;ck">');

?>



</body>
</html>
