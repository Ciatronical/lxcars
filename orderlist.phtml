<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />

<?php
    require_once("../inc/stdLib.php");
    $menu = $_SESSION['menu'];
    echo $menu['stylesheets'];
    echo $menu['javascripts'];
    echo $head['JQUERY'];
    echo $head['JQUERYUI'];
    echo $head['JQTABLE'];
    //echo $head['JQTABLE-PAGER'];
    echo $head['THEME'];
    echo $head['JUI-DROPDOWN'];
    echo $head['TRANSLATION'];


    /*****************************************************************************************************************************
    Grundsätze: Content wird via Ajax im Json-Format geholt und an die entsprechenden Container verteilt
                Daten werden ohne Reload einfach via Ajax gespeichert.
                Fürs Holen und Schreiben von Daten befindet sich unter jqhelp eine gleichnamige Datei mit der Extension ".php"
                Auf das Benutzen der Variable $_SESSION sollte weitestgehend verzichtet werden.
                Statt JS einzusetzen sollte auf die jQuery-Methoden zurückgegriffen werden.
                Url-Parameter können mit $.urlParam( 'ParameterName' ) gelesen werden.
                Beispiel automatische Übersetzung
    ******************************************************************************************************************************/

/*************************************************************/
/************************ LxCars Auftrag *********************/
/************** ronny@lxcars.de, April 2010 ******************/
/*************************************************************/
//include_once( "../inc/stdLib.php" );
include_once("inc/lxcLib.php");
include_once("../inc/template.inc");
include_once("../inc/UserLib.php");
include_once ( "../inc/crmLib.php" );

ob_start();
$task = $_GET["task"] ? $_GET["task"] : $_POST["task"];
$c_id = $_GET["c_id"] ? $_GET["c_id"] : $_POST["c_id"];
$owner = $_GET["owner"] ? $_GET["owner"] : $_POST["owner"];
$a_id = $_GET["a_id"] ? $_GET["a_id"] : $_POST["a_id"];
$b = $_GET["b"] ? $_GET["b"] : $_POST["b"]; if( !$b ) $b = 2 ;//ZurückButton 1==Suche, 2==Fahrzeug
$cd = ShowCar( $c_id );//Fahrzeugdaten holen
?>


<script>


$(document).ready(function() {

    //URL-Parameter lesen
    $.urlParam = function( name ){
        var results = new RegExp( '[\?&]' + name + '=([^&#]*)' ).exec( window.location.href );
        if( results == null ) alert( 'Parameter: "' + name + '" does not exist in "' + window.location.href + '"!' );
        else decodeURIComponent( results[1] || 0 );        }

    //alert( $.urlParam( 'param2' ) );

    var language = kivi.myconfig.countrycode;
    $( ".lang" ).each( function(){
        var key = $( this ).attr( "data-lang" );
        if( $( this ).is( ":input" ) ) $( this ).attr( 'title',  typeof( langData[language][key] ) != 'undefined' ? langData[language][key] : 'LNG ERR'  );
        else $( this ).text( typeof( langData[language][key] ) != 'undefined' ? langData[language][key] : 'LNG ERR'  );
    });

    $("#showtable").tablesorter().tablesorterPager({
        container: $("#pager"),
        size: 9999
    });

    $('.showtableRow').click(function () {
        //console.log($(this).attr('id'));
        window.location = 'order_test.phtml?task=<?php echo $task ?>&id='+$(this).attr('id')+'&owner=<?php echo $owner;?>&c_id=<?php echo $c_id;?>';
    })

    $('#btnNewOrder').button().click(function () {
        //console.log($('#ownerID').text());
        //window.location = 'order_test.phtml?id=0&owner=<?php echo $owner;?>&c_id=<?php echo $c_id;?>';
        $.ajax({
            url: 'ajax/order.php?action=getOrderNumber',
            type: 'GET',
            success: function (data) {
                var newOrderNr;
                newOrderNr = parseInt( data[0]['sonumber'] );
                newOrderNr =  newOrderNr + 1;
                window.location = 'order_test.phtml?task=<?php echo $task ?>&id='+newOrderNr+'&owner=<?php echo $owner;?>&c_id=<?php echo $c_id;?>';
            },
            error:  function(){ alert("Holen der Auftrags-Nr fehlgeschlagen!"); }
        })
    });

    $('#btnBack').button().click(function () {
        //console.log($('#ownerID').text());
        //window.location = 'order_test.phtml?id=0&owner=<?php echo $owner;?>&c_id=<?php echo $c_id;?>';
                window.location = 'lxcmain.php?task=<?php echo $task ?>&owner=<?php echo $owner;?>&c_id=<?php echo $c_id;?>';
    });

});

</script>

<style>
 .ui-menu { width: 180px; }
 .tablesorter { width:auto; cursor:pointer; widgets: ['zebra']; sortList: [[0,0]];}

</style>
</head>

<body>
<?php
    echo $menu['pre_content'];
    echo $menu['start_content'];
?>

<?php echo $menu['end_content']; ?>


 <p class="ui-state-highlight ui-corner-all tools lang" style="margin-top: 20px; padding: 0.6em;" data-lang="TESTFILE">Testfile</p>

<?php
//echo $task;
//echo $c_id;
//echo $owner;
//echo $a_id;
//echo $b;
//printArray($cd);
//+++++++++++++$rs = $GLOBALS['dbh']->getAll('SELECT oe.ordnumber, oe.transdate, oe.amount, oe.status, oe.employee_id, employee.id, employee.name FROM oe, employee WHERE oe.c_id = '.$c_id.' AND employee.id = oe.employee_id ORDER BY ordnumber');
//printArray($rs);
//$rs = $GLOBALS['dbh']->getAll('SELECT oe.ordnumber, oe.transdate, oe.amount, oe.status, oe.employee_id, employee.id, employee.name FROM oe, employee WHERE oe.customer_id = '.$owner.' AND oe.c_id = '.$c_id.' AND employee.id = oe.employee_id ORDER BY ordnumber');
//printArray($rs);

    echo (' <table id="showtable" class="tablesorter">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Auftrags-Nr.</th>
                        <th>Erster Posten</th>
                        <th>Betrag</th>
                    </tr>
                </thead>
                <tbody>');
                
                $rs = $GLOBALS['dbh']->getAll('
                    SELECT
                        oe.ordnumber,
                        oe.transdate,
                        oe.amount,
                        oe.status,
                        oe.employee_id,
                        orderitems.trans_id,
                        orderitems.description
                    FROM
                        oe,
                        orderitems
                    WHERE
                        oe.customer_id = '.$owner.'
                    AND
                        oe.c_id = '.$c_id.'
                    AND
                        orderitems.trans_id = oe.id
                    AND
                        orderitems.position = 1
                    ORDER BY
                        oe.ordnumber');
                        
                    foreach ($rs as $value){
                        //$var = sprintf(round($value['amount'], 2) == intval($value['amount']) ? "%d" : "%.2f", $value['amount']);
                        //$var = number_format($value['amount'], 2, ',', '.');
                        //echo $var;
                        echo ('
                            <tr id="'.$value['ordnumber'].'" class="showtableRow">
                                <td>'.$value['transdate'].'</td>
                                <td>'.$value['ordnumber'].'</td>
                                <td>'.$value['description'].'</td>
                                <td align="right">'.number_format($value['amount'], 2, ',', '.').'</td>
                            </tr>');
                        //echo ($value['ordnumber'].', '.$value['transdate'].', '.number_format($value['amount'], 2, ',', '.').', '.$value['name'].'<br>');
                    }
                    echo (  '</tbody></table>'
                            .$head["JQTABLE-PAGER"].
                            '<input type="button" id="btnNewOrder" value="Neuer Auftrag">
                            <input type="button" id="btnBack" value="Zur&uuml;ck">');

?>

 <div id="senddialog" > </div>
<!--
 <div id="gdtable" class="gdtable">
  <table id="showtable" class="tablesorter" >
   <thead>
    <tr>
     <th>ID</th>
     <th data-lang='BIRTHDAY' class='lang'>Birthday</th>
     <th data-lang='NAME' class='lang'>Name</th>
     <th data-lang='AGE' class='lang'>Age</th>
     <th data-lang='COMMENTS' class='lang'>Comments</th>
    </tr>
   </thead>
   <tbody id="tbody0"></tbody>
   <tfoot></tfoot>
  </table>
  <div id="pager"> <?php echo $head['JQTABLE-PAGER']; ?> </div>

 </div>

 <div id="newbtn" ></div>
-->


<!-- <div id="pager"> <?php echo $head['JQTABLE-PAGER']; ?> </div> -->




<!-- <table class="tablesorter">
  <thead>
    <tr>
     <th>Name</th>
     <th>Alter</th>
     <th>Bemerkungen</th>
    </tr>
  </thead>
  <tbody id="tsok">
   <tr>
    <td>Anton</td>
    <td>89</td>
    <td>alt</td>
   </tr>
   <tr>
    <td>Berta</td>
    <td>45</td>
    <td>jünger</td>
   </tr>
   <tr>
    <td>Cäsar</td>
    <td>1000</td>
    <td>ganz alt</td>
   </tr>
  </tbody>
 </table>-->



</body>
</html>
